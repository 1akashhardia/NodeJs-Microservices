name: CI/CD to EKS  

on:  
  push:  
    branches: [main]  
  workflow_dispatch:

jobs:  
  build:  
    runs-on: ubuntu-latest  
    steps:  
      - uses: actions/checkout@v4  
      - uses: actions/setup-node@v4  
        with:  
          node-version: '20'  
      - run: npm i 
      - run: npm test  
  
  push:  
    needs: build  
    runs-on: ubuntu-latest  
    steps:  
      - uses: actions/checkout@v4  
      - uses: aws-actions/configure-aws-credentials@v4  
        with:  
          role-arn: ${{ secrets.AWS_ROLE_ARN }}  
          aws-region: us-east-1  
      - run: aws ecr get-login-password | docker login --username AWS --password-stdin ${{ secrets.ECR_REPO }}  
      - run: docker build -t ${{ secrets.ECR_REPO }}/message:${{ github.sha }} ./message  
      - run: docker build -t ${{ secrets.ECR_REPO }}/peep:${{ github.sha }} ./peep  
      - run: docker build -t ${{ secrets.ECR_REPO }}/query:${{ github.sha }} ./query  
      - run: docker push ${{ secrets.ECR_REPO }}/message:${{ github.sha }}  
      - run: docker push ${{ secrets.ECR_REPO }}/peep:${{ github.sha }}  
      - run: docker push ${{ secrets.ECR_REPO }}/query:${{ github.sha }}  
  
  deploy:  
    needs: push  
    runs-on: ubuntu-latest  
    steps:  
      - uses: actions/checkout@v4  
      - uses: aws-actions/configure-aws-credentials@v4  
        with:  
          role-arn: ${{ secrets.AWS_ROLE_ARN }}  
          aws-region: us-east-1  
      - run: aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER }}  
      - uses: azure/setup-helm@v4  
      - run: helm upgrade --install microservices-app ./charts/microservices-app --set tag=${{ github.sha }}  