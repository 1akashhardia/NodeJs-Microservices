name: CI/CD to EKS

on:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      # Message-Service
      - name: Install deps for Message-Service
        working-directory: ./Message-Service
        run: npm ci
      - name: Test Message-Service  # Uncomment if tests exist
        working-directory: ./Message-Service
        run: npm test || true  # '|| true' to ignore if no tests
      # Peeps-Service
      - name: Install deps for Peeps-Service
        working-directory: ./Peeps-Service
        run: npm ci
      - name: Test Peeps-Service
        working-directory: ./Peeps-Service
        run: npm test || true
      # Query-Service
      - name: Install deps for Query-Service
        working-directory: ./Query-Service
        run: npm ci
      - name: Test Query-Service
        working-directory: ./Query-Service
        run: npm test || true
      # front-end (NextJS)
      - name: Install deps for front-end
        working-directory: ./front-end
        run: npm ci
      - name: Test front-end
        working-directory: ./front-end
        run: npm test || true

  push:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-arn: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      - run: aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REPO }}
      # Build and push each service
      - run: docker build -t ${{ secrets.ECR_REPO }}/message-service:${{ github.sha }} ./Message-Service
      - run: docker push ${{ secrets.ECR_REPO }}/message-service:${{ github.sha }}
      - run: docker build -t ${{ secrets.ECR_REPO }}/peeps-service:${{ github.sha }} ./Peeps-Service
      - run: docker push ${{ secrets.ECR_REPO }}/peeps-service:${{ github.sha }}
      - run: docker build -t ${{ secrets.ECR_REPO }}/query-service:${{ github.sha }} ./Query-Service
      - run: docker push ${{ secrets.ECR_REPO }}/query-service:${{ github.sha }}
      - run: docker build -t ${{ secrets.ECR_REPO }}/front-end:${{ github.sha }} ./front-end
      - run: docker push ${{ secrets.ECR_REPO }}/front-end:${{ github.sha }}

  deploy:
    needs: push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-arn: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      - run: aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER }} --region ${{ secrets.AWS_REGION }}
      - uses: azure/setup-helm@v4
      - run: helm upgrade --install microservices-app ./charts/microservices-app --set tag=${{ github.sha }} --set ecrRepo=${{ secrets.ECR_REPO }}